<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Test</title>
        <link href="//api.mapbox.com/mapbox.js/v3.1.1/mapbox.css" rel="stylesheet" type="text/css">
    </head>
    <body>
        <script src="//code.jquery.com/jquery-3.3.1.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
        <script src="//api.mapbox.com/mapbox.js/v3.1.1/mapbox.js"></script>
    
        <div class="toolbar">
            <button id="start">Start</button>
            <button id="pause" style="display: none;">Pause</button>
            <button id="resume" style="display: none;">Resume</button>
            <button id="stop" style="display: none;">Stop</button>
        </div>

        <p>Time: <span id="timer"></span></p>
        <p>Start Time: <span id="startTime"></span></p>
        <p>End Time: <span id="endTime"></span></p>
        <p>Distance <span id="distance"></span> km</p>

        <ul id="journeyParts"></ul>

        <div id="map" style="width:100%;height:480px;border:#000 2px solid;"></div>

        <script type="text/javascript">

            L.mapbox.accessToken = "pk.eyJ1IjoidGhlZmxvb3ciLCJhIjoiaGFWLVhLRSJ9.X1fJCnMuqwE9wzFiitHiUw";

            let map = L.mapbox.map("map", null, {
                        worldCopyJump: !0,
                        maxBounds: [
                            [-90, -180],
                            [90, 180]
                        ],
                        tileLayer: {
                            continuousWorld: !1,
                            noWrap: !0
                        },
                        zoomControl: false,
                        attributionControl: false
                    })
                    .setView([53.3871228,-1.4658309], 16)
                    .addLayer(L.mapbox.styleLayer('mapbox://styles/mapbox/streets-v11'));

            map.dragging.disable();
            map.touchZoom.disable();
            map.doubleClickZoom.disable();
            map.scrollWheelZoom.disable();
            map.boxZoom.disable();

            let journeyInterval = null,
                isPaused = false;

            let journeyLine = false;

            let journeyPartMilliseconds = 1;

            const Journey = {}

            Journey.journeyParts = [];

            Journey.distance = 0;

            navigator.geolocation.getCurrentPosition(function(position){
                
            }, function(err) { }, { enableHighAccuracy: true });

            function addJourneyPart() {

                let journeyPart = {};
                journeyPart.dateTime = new Date();

                navigator.geolocation.getCurrentPosition(function(position){
                    journeyPart.latitude = position.coords.latitude;
                    journeyPart.longitude = position.coords.longitude;
                    Journey.journeyParts.push(journeyPart);
                    if(journeyLine) {
                        journeyLine.addLatLng([journeyPart.latitude, journeyPart.longitude])
                    } else {
                        journeyLine = L.polyline([[journeyPart.latitude, journeyPart.longitude]], {
                            color: 'black',
                            opacity: 1,
                            weight: 4,
                        }).addTo(map);
                    }
                    map.setView([journeyPart.latitude, journeyPart.longitude], 16)
                }, function(err) { }, { enableHighAccuracy: true });
            }

            function startJourney() {
                Journey.startTime = new Date();
                $('#startTime').html(Journey.startTime);
                isRecording = true;
                journeyInterval = setInterval(function(){
                    if(isPaused) return;
                        addJourneyPart();
                        updateTimer();
                        updateDistance();
                }, journeyPartMilliseconds);
            }

            function updateTimer() {
                let endTime = new Date();
                let startTime = Journey.startTime;
                // using the main startTime means pause will jump!
                // Journey.journeyParts[Journey.journeyParts.length-1].dateTime
                let diff = moment.duration(moment(endTime).diff(startTime));
                // , diff.milliseconds()
                $('#timer').html([diff.hours(), diff.minutes(), diff.seconds()].join(':'))
            }

            function updateDistance() {
                let coords = getLatLng(Journey.journeyParts);
                let distance = calculateDistance(coords[0][0], coords[0][1], 
                coords[coords.length-1][0], 
                coords[coords.length-1][1]);
                Journey.distance = Journey.distance + distance;
                $('#distance').html(Journey.distance);
            }

            function stopJourney() {
                clearInterval(journeyInterval);
                Journey.endTime = new Date();
                $('#endTime').html(Journey.endTime);
            }

            function pauseJourney() {
                isPaused = true;
            }

            function resumeJourney() {
                isPaused = false;
            }

            $(document).on('click', '#start', function(e) {
                e.preventDefault();
                $('#start').hide();
                $('#stop, #pause').show();
                startJourney();
            });

            $(document).on('click', '#stop', function(e) {
                e.preventDefault();
                $('#start, #stop, #pause, #resume').hide();
                stopJourney();
            });

            $(document).on('click', '#pause', function(e) {
                e.preventDefault();
                pauseJourney();
                $('#pause').hide();
                $('#resume').show();
            });

            $(document).on('click', '#resume', function(e) {
                e.preventDefault();
                resumeJourney();
                $('#pause').show();
                $('#resume').hide();
            });

            function getLatLng(t) {
                for (var e = [], n = 0; n < t.length; n++) e.push([t[n].latitude, t[n].longitude]);
                return e;
            }

            function calculateDistance(lat1, lon1, lat2, lon2) {
                var R = 6371; // km
                var dLat = (lat2 - lat1).toRad();
                var dLon = (lon2 - lon1).toRad(); 
                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(lat1.toRad()) * Math.cos(lat2.toRad()) * 
                        Math.sin(dLon / 2) * Math.sin(dLon / 2); 
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); 
                var d = R * c;
                return d;
            }

            Number.prototype.toRad = function() {
                return this * Math.PI / 180;
            }

        </script>
    </body>
</html>